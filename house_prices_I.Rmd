---
title: "Master's Thesis"
author: "Maria del Mar Escalas Martorell"
date: "`r Sys.Date()`"
output: html_document
description: "This is the first .Rmd document from a set of three .Rdm. Code provided is complemetary to the main document ***** that can be found in this repository. This markdown contains the code needed for conducting the analysis until point 2. ANALYSIS OF THE SITUATION included."
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.align = "center")
```

Loading libraries.

```{r message = FALSE, warning = FALSE}
# General libraries:
library(tidyverse)
library(stringr) # regex
library(lubridate) # operations with dates

# Web scraping libraries:
library(xml2)
library(httr)
library(scrapex)
library(rvest) # read_html

# Libraries for editing plots and tables:
library(ggplot2)
library(RColorBrewer)
library(wordcloud)
library(sf) # geometry polygons
library(zoo) # date (quarters)
library(leaflet) # maps

# Times New Roman font import:
library(extrafont)

# Operations with geodata
library(geosphere)
```

## 1. INTRODUCTION

### 1.1. Motivation of the work
No code

### 1.2. Ojectives
No code

### 1.3. Methodology
No code

### 1.4. Technical requirements and precautions
No code

## 2. ANALYSIS OF THE SITUATION

### Prices of dwellings in Spain

#### Plot 1: Housing Price Index (HPI) variation over time (quarters)

Source: [INE](https://www.ine.es/jaxiT3/Datos.htm?t=25171)

[Dataviz](https://csslab.uc3m.es/dataviz/)

Reading raw data from .csv file.

```{r}
hpi <- read_delim("Data/dwelling_price_index_INE.csv", 
                  delim = ";", skip = 1, col_types = "c", 
                  col_names = c("remove1", "Group", "remove2", "remove3", "Period", "HPI")) %>%
  select(-c("remove1", "remove2", "remove3"))

head(hpi)
```

Organizing the dataframe information:

- Substituting *NAs* in *Group* column by *Total National*.
- Substituting *Madrid* in *Group* column by *Community of Madrid*.
- Substituting commas per dots in *HPI* and converting to numeric column type. 

```{r}
hpi <- hpi %>%
  mutate(Group = ifelse(is.na(Group), "Total national", 
                        sub(".*Madrid.*", "Community of Madrid", Group)),
         HPI = as.numeric(sub(",", ".", HPI)),
         Period = str_replace(Period, "T", ""))

head(hpi)
```

Plotting:

- Formatting *Period* information into year quarters.

```{r}
hpi <- hpi %>%
  mutate(Period = as.yearqtr(format(Period), "%Y%q"))
```

- Times New Roman font is not available in R by default. It should be imported.

The decision in this case has been to import all fonts in this device and see that Times New Roman is already installed,
so it can be used now in R.

```{r}
# font_import()
# loadfonts(device = "win")
# fonts() to consult available fonts to use in R
```

- Plot.

```{r fig.height = 5, fig.width = 8.5}
hpi %>% 
  ggplot(aes(y = HPI, x = Period, group = Group, color = Group)) + 
  geom_line(linewidth = 1.3) + 
  labs(x = NULL, y = NULL) +
  theme(legend.title = element_blank(),
        legend.position = c(0.80, 0.20),
        legend.background = element_rect(color = "black", fill = "white"),
        axis.text.x = element_text(angle = 45, vjust = 0.5, color = "black"),
        axis.text.y = element_text(angle = 0, hjust = 1, color = "black"),
        axis.line = element_line(color = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_rect(fill = "white"),
        legend.spacing.y = unit(0.03, "cm"), # adjust legend box
        legend.key = element_rect(fill = "transparent"),
        text = element_text(family = "Times New Roman", size = 18, color = "black")) +
  scale_color_manual(values = c("darkblue", "red")) +
  geom_hline(yintercept = 0, 
             linetype = "dashed", 
             color = "black", linewidth = 0.5) +
  scale_y_continuous(limits = c(-7.5, 7.5), breaks = seq(-7.5, 7.5, by = 3),
                     labels = function(x) paste0(x, "%")) + # Add "%" symbol to y-labels
  scale_x_yearqtr(format = "%Y", # format = "%YQ%q" to put QX after each label
                  limits = c(min(hpi$Period), max(hpi$Period)),
                  breaks = seq(from = min(hpi$Period), to = max(hpi$Period), by = 1),
                  expand = c(0, 0.5)) +
  geom_vline(xintercept = as.numeric(seq(min(hpi$Period), max(hpi$Period), by = 1)), 
             linetype = "dashed",
             color = "grey")
```

#### Data bank from Madrid Council - Statistical information

Evolution of the average price per square meter by district and neighbourhood (City of Madrid)

Full data:

```{r}
madrid_m2 <- read_delim("Data/price_m2_Madrid_district_neighbourhood.csv", 
                        delim = ";", skip = 5, 
                        n_max = 161, # skip last 4 rows
                        col_names = c("District", "Neighbourhood", "2017", "2018", "2019", "2020", "2021", "2022"),
                        show_col_types = FALSE) %>% 
  mutate(across(starts_with("20"), ~as.numeric(str_replace_all(., "\\.", "")))) # substitute dots per nothing and convert to numeric

madrid_m2
```

#### Plot 2: Average price per square meter of second-hand dwellings by District in 2022 (€ per square meter) & Increase in price per square meter: 2017 vs. 2022, in %

```{r}
madrid_districts <- madrid_m2 %>%
  filter(str_detect(Neighbourhood, '^\\d{2}\\.') | Neighbourhood == "Ciudad de Madrid") %>% # de la columna de neighbourhood que empiece por dos dígitos, seguido por un punto
  rename("remove" = "District", "District" = "Neighbourhood") %>%
  select(-"remove")

madrid_districts
```

```{r}
madrid_districts <- madrid_districts %>%
  mutate(District = gsub("^\\d{2}\\.\\s*", "", District),
         District = ifelse(District == "Ciudad de Madrid", "City of Madrid", District),
         Variation = round(((`2022` - `2017`) / `2017`) * 100, 2))
```

```{r}
madrid_longer <- madrid_districts %>%
  pivot_longer(!District, names_to = c("Year"), values_to = "price per m2")

madrid_longer
```

```{r fig.height = 5, fig.width = 8.5}
madrid_longer %>%
  filter(Year == "2022") %>%
  ggplot(aes(x = reorder(District, `price per m2`), y = `price per m2`)) +
  labs(x = NULL, y = NULL) +
  geom_bar(stat = "identity", fill = "darkblue") +
  coord_flip() +
  geom_rect(xmin = -Inf, xmax = Inf, ymin = 6900, ymax = 7900, fill = "lightblue") +
  geom_text(aes(label = `price per m2`), hjust = 1.1, nudge_x = 0.1, color = "white", family = "Times New Roman", size = 5, fontface = "bold") +
  scale_y_continuous(limits = c(0, 7900), expand = c(0, 0), breaks = NULL) +
  geom_text(data = madrid_longer %>% filter(Year == "Variation"), aes(x = District, y = 7400, label = paste0(`price per m2`, "%")), vjust = 0.35, family = "Times New Roman", size = 5, fontface = "bold") +
  theme_minimal() +
  theme(text = element_text(family = "Times New Roman", size = 20),
        axis.text.y = element_text(vjust = 0.35, color = "black")) # Manejar la altura de los distritos con respecto a las barras
```

#### Plot 3: Average price per sq meter of Districts in Madrid

```{r}
madrid_map <- madrid_m2 %>% 
  filter(str_detect(Neighbourhood,'^\\d{2}\\.')) %>% # start by two digits followed by a dot
  rename("remove" = "District", "District" = "Neighbourhood") %>% 
  select(-"remove") 

madrid_map
```

[Geodata 21 districts from Madrid municipality](https://datos.madrid.es/portal/site/egob/menuitem.c05c1f754a33a9fbe4b2e4b284f1a5a0/?vgnextoid=7d6e5eb0d73a7710VgnVCM2000001f4a900aRCRD&vgnextchannel=374512b9ace9f310VgnVCM100000171f5a0aRCRD&vgnextfmt=default)

```{r}
geodata_districts <- read_sf(dsn = "./Data", # "." = current directory
  layer = "Geodata_Districts")

geodata_districts <- geodata_districts %>% 
  mutate(NOMBRE = case_when(NOMBRE == "San Blas - Canillejas" ~ "San Blas-Canillejas",
                            NOMBRE == "Fuencarral - El Pardo" ~ "Fuencarral-El Pardo",
                            NOMBRE == "Moncloa - Aravaca" ~ "Moncloa-Aravaca",
                            TRUE ~ NOMBRE),
         District = paste0(COD_DIS_TX, ". ", NOMBRE)) %>% select(District)

geodata_districts
```

```{r}
madrid_map <- madrid_map %>% left_join(geodata_districts, by = "District")
```

```{r fig.height = 6, fig.width = 8.5}
madrid_map %>%
ggplot(aes(fill = `2022`, geometry = geometry)) +
  geom_sf(color = "black") +
  scale_fill_gradient(low = "ivory", high = "orangered") +
  labs(x = NULL, y = NULL) +
  theme_void() +
  theme(text = element_text(family="Times New Roman"),
        legend.title = element_blank(),
        legend.key = element_blank(),
        legend.position = c(1.1, 0.8),
        legend.direction = "vertical",
        legend.text = element_text(size = 15),
        plot.margin = margin(0, 0, 0, 0, "pt"))  +
  annotate("text", x = 426800, y = 4472900, label = "Centro", # 1 OK
           size = 5, family = "Times New Roman") +
  annotate("text", x = 434000, y = 4461000, label = "Arganzuela", # 2 OK
           size = 5, family = "Times New Roman") +
  annotate("text", x = 456500, y = 4466000, label = "Retiro", # 3 OK
           size = 5, family = "Times New Roman") +
  annotate("text", x = 457000, y = 4486500, label = "Salamanca", # 4
           size = 5, family = "Times New Roman") +
  annotate("text", x = 448200, y = 4487500, label = "Chamartín", # 5 OK
           size = 5, family = "Times New Roman") +
  annotate("text", x = 445500, y = 4490000, label = "Tetuán", # 6 OK
           size = 5, family = "Times New Roman") +
  annotate("text", x = 425900, y = 4474600, label = "Chamberí", # 7 OK
           size = 5, family = "Times New Roman") +
  annotate("text", x = 435000, y = 4487500, label = "Fuencarral-\nEl Pardo", # 8
           size = 5, family = "Times New Roman") +
  annotate("text", x = 436800, y = 4477500, label = "Moncloa-\nAravaca", # 9
           size = 4, family = "Times New Roman") +
  annotate("text", x = 433000, y = 4470500, label = "Latina", # 10
           size = 5, family = "Times New Roman") +
  annotate("text", x = 427500, y = 4463000, label = "Carabanchel", # 11
           size = 5, family = "Times New Roman") +
  annotate("text", x = 440400, y = 4469200, label = "Usera", # 12
           size = 3.5, family = "Times New Roman") +
  annotate("text", x = 451000, y = 4460000, label = "Puente de Vallecas", # 13
           size = 5, family = "Times New Roman") +
  annotate("text", x = 457500, y = 4468000, label = "Moratalaz", # 14
           size = 5, family = "Times New Roman") +
  annotate("text", x = 459000, y = 4480000, label = "Ciudad \nLineal", # 15
           size = 5, family = "Times New Roman") +
  annotate("text", x = 446200, y = 4482500, label = "Hortaleza", # 16
           size = 4, family = "Times New Roman") +
  annotate("text", x = 441000, y = 4466000, label = "Villaverde", # 17
           size = 3.5, family = "Times New Roman") +
  annotate("text", x = 447500, y = 4467000, label = "Villa de \nVallecas", # 18
           size = 5, family = "Times New Roman") +
  annotate("text", x = 451000, y = 4472000, label = "Vicálvaro", # 19
           size = 5, family = "Times New Roman") +
  annotate("text", x = 448800, y = 4476100, label = "San Blas-\nCanillejas", # 20
           size = 3.5, family = "Times New Roman") +
  annotate("text", x = 451500, y = 4480500, label = "Barajas", # 21
            size = 5, family = "Times New Roman") +
  geom_segment(aes(x = 442500, y = 4480000, xend = 445300, yend = 4486600), # Chamartín
             linewidth = 0.5, color = "black") +
  geom_segment(aes(x = 441000, y = 4480000, xend = 444300, yend = 4489000), # Tetuán
             linewidth = 0.5, color = "black") +
  geom_segment(aes(x = 445000, y = 4477000, xend = 456500, yend = 4480000), # Ciudad Lineal
             linewidth = 0.5, color = "black") +
  geom_segment(aes(x = 442500, y = 4475800, xend = 454000, yend = 4485600), # Salamanca
             linewidth = 0.5, color = "black") +
  geom_segment(aes(x = 445000, y = 4473200, xend = 454000, yend = 4468000), # Moratalaz
             linewidth = 0.5, color = "black") +
  geom_segment(aes(x = 442500, y = 4473200, xend = 454000, yend = 4466000), # Retiro
             linewidth = 0.5, color = "black") +
  geom_segment(aes(x = 443000, y = 4469000, xend = 445900, yend = 4460800), # Puente de Vallecas
             linewidth = 0.5, color = "black") +
  geom_segment(aes(x = 434000, y = 4461500, xend = 440400, yend = 4472500), # Arganzuela
             linewidth = 0.5, color = "black") +
  geom_segment(aes(x = 430000, y = 4464000, xend = 436800, yend = 4469200), # Carabanchel
             linewidth = 0.5, color = "black") +
  geom_segment(aes(x = 429000, y = 4472800, xend = 440400, yend = 4474500), # Centro
             linewidth = 0.5, color = "black") +
  geom_segment(aes(x = 429000, y = 4474500, xend = 440400, yend = 4476200), # Chamberí
             linewidth = 0.5, color = "black")
```

## REFERENCES




